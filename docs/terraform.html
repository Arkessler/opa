
<!DOCTYPE HTML>
<html lang="">
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Terraform Testing &#xB7; GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-ace/ace.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

    

        
    
    
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="ceph-authorization.html">
    
    
    <link rel="prev" href="kubernetes-admission-control.html">
    

    </head>
    <body>
        
<div class="book"><div class="_doc--header">
  <div class="header _doc--container">

      <div class="_doc--logo header--logo">
        <a class="header--logo-link" href="/">
          <img class="header--logo-image" src="images/opa-logo.svg" alt="">
          <p class="header--logo-txt">
            Open Policy Agent
          </p>
        </a>
      </div>

      <div class="_doc--menu-mobile">
        <button class="hamburger hamburger--spring" type="button" style="outline: none; padding-bottom: 8px;">
          <span class=" hamburger-box">
            <span class="menu-mobile--hamburger-inner hamburger-inner"></span>
          </span>
        </button>
      </div>

      <div class="_doc--menu-desktop header--menu">
        <a class="header--link header--link_LONG" href="/docs/">
          <p class="header--menu-txt">
            Documentation
          </p>
        </a>
        <a class="header--link header--link_LONG" href="/docs/get-started.html">
          <p class="header--menu-txt">
            Tutorials
          </p>
        </a>
        <a class="header--link header--social-link" href="https://blog.openpolicyagent.org/" target="_blank">
          <img class="header--menu-image" src="images/Medium.svg" alt="">
        </a>
        <a class="header--link header--social-link" href="https://github.com/open-policy-agent/opa" target="_blank">
          <img class="header--menu-image" src="images/Github.svg" alt="">
        </a>
        <a class="header--link header--social-link" href="http://slack.openpolicyagent.org" target="_blank">
          <img class="header--menu-image" src="images/Slack.svg" alt="">
        </a>
      </div>

  </div>
</div>

<div class="_doc--hamburger-menu-container">

  <a class="header--hamburger-menu-link" href="/docs">
    <li class="header--hamburger-menu-item">
      <p class="header--menu-txt">
        Documentation
      </p>
    </li>
  </a>

  <a class="header--hamburger-menu-link" href="/docs/get-started.html">
    <li class="header--hamburger-menu-item">
      <p class="header--menu-txt">
        Tutorials
      </p>
    </li>
  </a>

  <a class="header--hamburger-menu-link" href="https://blog.openpolicyagent.org/" target="_blank">
    <li class="header--hamburger-menu-item">
      <img class="header--menu-image" src="images/Medium.svg" alt="">
    </li>
  </a>

  <a class="header--hamburger-menu-link" href="https://github.com/open-policy-agent/opa" target="_blank">
    <li class="header--hamburger-menu-item">
      <img class="header--menu-image" src="images/Github.svg" alt="">
    </li>
  </a>

  <a class="header--hamburger-menu-link" href="http://slack.openpolicyagent.org/" target="_blank">
    <li class="header--hamburger-menu-item">
      <img class="header--menu-image" src="images/Slack.svg" alt="">
    </li>
  </a>


</div>

    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search">
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        <li class="header">Documentation</li>
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="./">
            
                <a href="./#what-is-policy">
            
                    
                    What is Policy?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="./">
            
                <a href="./#what-is-policy-enablement">
            
                    
                    What is Policy Enablement?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="./">
            
                <a href="./#what-is-opa">
            
                    
                    What is OPA?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="./">
            
                <a href="./#why-use-opa">
            
                    
                    Why use OPA?
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html">
            
                    
                    How Does OPA Work?
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html#overview">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html#deployment">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html#data-and-policies">
            
                    
                    Data and Policies
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.3.1" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html#base-documents">
            
                    
                    Base Documents
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.2" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html#policies">
            
                    
                    Policies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.3" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html#rules-and-virtual-documents">
            
                    
                    Rules and Virtual Documents
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.4" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html#the-data-document">
            
                    
                    The data Document
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.5" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html#the-input-document">
            
                    
                    The input Document
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="how-does-opa-work.html">
            
                <a href="how-does-opa-work.html#putting-it-all-together">
            
                    
                    Putting It All Together
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html">
            
                    
                    How Do I Write Policies?
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#what-is-rego">
            
                    
                    What is Rego?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#why-use-rego">
            
                    
                    Why use Rego?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#the-basics">
            
                    
                    The Basics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#scalar-values">
            
                    
                    Scalar Values
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#composite-values">
            
                    
                    Composite Values
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.5.1" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#sets">
            
                    
                    Sets
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#variables">
            
                    
                    Variables
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#references">
            
                    
                    References
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.7.1" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#variable-keys">
            
                    
                    Variable Keys
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7.2" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#multiple-expressions">
            
                    
                    Multiple Expressions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7.3" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#self-joins">
            
                    
                    Self-Joins
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#comprehensions">
            
                    
                    Comprehensions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.8.1" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#array-comprehensions">
            
                    
                    Array Comprehensions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8.2" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#object-comprehensions">
            
                    
                    Object Comprehensions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8.3" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#set-comprehensions">
            
                    
                    Set Comprehensions
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#rules">
            
                    
                    Rules
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.9.1" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#generating-sets">
            
                    
                    Generating Sets
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9.2" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#generating-objects">
            
                    
                    Generating Objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9.3" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#incremental-definitions">
            
                    
                    Incremental Definitions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9.4" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#complete-definitions">
            
                    
                    Complete Definitions
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#functions">
            
                    
                    Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.11" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#negation">
            
                    
                    Negation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.12" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#modules">
            
                    
                    Modules
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.12.1" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#comments">
            
                    
                    Comments
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.12.2" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#imports">
            
                    
                    Imports
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.13" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#with-keyword">
            
                    
                    With Keyword
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.14" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#default-keyword">
            
                    
                    Default Keyword
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.15" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#else-keyword">
            
                    
                    Else Keyword
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.16" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#operators">
            
                    
                    Operators
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.16.1" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#equality">
            
                    
                    Equality
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.16.2" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#assignment">
            
                    
                    Assignment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.16.3" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#comparison">
            
                    
                    Comparison
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.17" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#built-in-functions">
            
                    
                    Built-in Functions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.18" data-path="how-do-i-write-policies.html">
            
                <a href="how-do-i-write-policies.html#example-data">
            
                    
                    Example Data
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="how-do-i-test-policies.html">
            
                <a href="how-do-i-test-policies.html">
            
                    
                    How Do I Test Policies?
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="how-do-i-test-policies.html">
            
                <a href="how-do-i-test-policies.html#getting-started">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="how-do-i-test-policies.html">
            
                <a href="how-do-i-test-policies.html#test-format">
            
                    
                    Test Format
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="how-do-i-test-policies.html">
            
                <a href="how-do-i-test-policies.html#test-discovery">
            
                    
                    Test Discovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="how-do-i-test-policies.html">
            
                <a href="how-do-i-test-policies.html#test-results">
            
                    
                    Test Results
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="how-do-i-test-policies.html">
            
                <a href="how-do-i-test-policies.html#data-mocking">
            
                    
                    Data Mocking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="how-do-i-test-policies.html">
            
                <a href="how-do-i-test-policies.html#coverage">
            
                    
                    Coverage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="how-do-i-test-policies.html">
            
                <a href="how-do-i-test-policies.html#profiling">
            
                    
                    Profiling
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="language-reference.html">
            
                <a href="language-reference.html">
            
                    
                    Language Reference
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="language-reference.html">
            
                <a href="language-reference.html#built-in-functions">
            
                    
                    Built-in Functions
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="language-reference.html">
            
                <a href="language-reference.html#comparison">
            
                    
                    Comparison
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="language-reference.html">
            
                <a href="language-reference.html#numbers">
            
                    
                    Numbers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="language-reference.html">
            
                <a href="language-reference.html#aggregates">
            
                    
                    Aggregates
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.4" data-path="language-reference.html">
            
                <a href="language-reference.html#sets">
            
                    
                    Sets
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.5" data-path="language-reference.html">
            
                <a href="language-reference.html#strings">
            
                    
                    Strings
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.6" data-path="language-reference.html">
            
                <a href="language-reference.html#types">
            
                    
                    Types
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.7" data-path="language-reference.html">
            
                <a href="language-reference.html#encoding">
            
                    
                    Encoding
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.8" data-path="language-reference.html">
            
                <a href="language-reference.html#tokens">
            
                    
                    Tokens
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.9" data-path="language-reference.html">
            
                <a href="language-reference.html#time">
            
                    
                    Time
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="language-reference.html">
            
                <a href="language-reference.html#reserved-names">
            
                    
                    Reserved Names
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="language-reference.html">
            
                <a href="language-reference.html#grammar">
            
                    
                    Grammar
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="configuration.html">
            
                <a href="configuration.html">
            
                    
                    Configuration Reference
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="configuration.html">
            
                <a href="configuration.html#example">
            
                    
                    Example
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="configuration.html">
            
                <a href="configuration.html#services">
            
                    
                    Services
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="configuration.html">
            
                <a href="configuration.html#miscellaenous">
            
                    
                    Miscellaneous
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="configuration.html">
            
                <a href="configuration.html#bundles">
            
                    
                    Bundles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="configuration.html">
            
                <a href="configuration.html#status">
            
                    
                    Status
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.6" data-path="configuration.html">
            
                <a href="configuration.html#decision-logs">
            
                    
                    Decision Logs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="configuration.html">
            
                <a href="configuration.html#discovery">
            
                    
                    Discovery
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="rest-api.html">
            
                <a href="rest-api.html">
            
                    
                    REST API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="rest-api.html">
            
                <a href="rest-api.html#policy-api">
            
                    
                    Policy API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="rest-api.html">
            
                <a href="rest-api.html#list-policies">
            
                    
                    List Policies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="rest-api.html">
            
                <a href="rest-api.html#get-a-policy">
            
                    
                    Get a Policy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.3" data-path="rest-api.html">
            
                <a href="rest-api.html#create-or-update-a-policy">
            
                    
                    Create or Update a Policy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.4" data-path="rest-api.html">
            
                <a href="rest-api.html#delete-a-policy">
            
                    
                    Delete a Policy
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="rest-api.html">
            
                <a href="rest-api.html#data-api">
            
                    
                    Data API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.2.1" data-path="rest-api.html">
            
                <a href="rest-api.html#get-a-document">
            
                    
                    Get a Document
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.2" data-path="rest-api.html">
            
                <a href="rest-api.html#get-a-document-with-input">
            
                    
                    Get a Document (with Input)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.3" data-path="rest-api.html">
            
                <a href="rest-api.html#get-a-document-webhook">
            
                    
                    Get a Document (Webhook)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.4" data-path="rest-api.html">
            
                <a href="rest-api.html#create-or-overwrite-a-document">
            
                    
                    Create or Overwrite a Document
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2.5" data-path="rest-api.html">
            
                <a href="rest-api.html#patch-a-document">
            
                    
                    Patch a Document
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="rest-api.html">
            
                <a href="rest-api.html#query-api">
            
                    
                    Query API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.1" data-path="rest-api.html">
            
                <a href="rest-api.html#execute-a-simple-query">
            
                    
                    Execute a Simple Query
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.2" data-path="rest-api.html">
            
                <a href="rest-api.html#execute-an-ad-hoc-query">
            
                    
                    Execute an Ad-hoc Query
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="rest-api.html">
            
                <a href="rest-api.html#compile-api">
            
                    
                    Compile API
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="rest-api.html">
            
                <a href="rest-api.html#partially-evaluate-a-query">
            
                    
                    Partially Evaluate a Query
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.5" data-path="rest-api.html">
            
                <a href="rest-api.html#authentication">
            
                    
                    Authentication
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.5.1" data-path="rest-api.html">
            
                <a href="rest-api.html#bearer-tokens">
            
                    
                    Bearer Tokens
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.6" data-path="rest-api.html">
            
                <a href="rest-api.html#errors">
            
                    
                    Errors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.7" data-path="rest-api.html">
            
                <a href="rest-api.html#explanations">
            
                    
                    Explanations
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.7.1" data-path="rest-api.html">
            
                <a href="rest-api.html#trace-events">
            
                    
                    Trace Events
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.8" data-path="rest-api.html">
            
                <a href="rest-api.html#performance-metrics">
            
                    
                    Performance Metrics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.9" data-path="rest-api.html">
            
                <a href="rest-api.html#watches">
            
                    
                    Watches
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="deployments.html">
            
                <a href="deployments.html">
            
                    
                    Deployments
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="deployments.html">
            
                <a href="deployments.html#docker">
            
                    
                    Docker
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1.1" data-path="deployments.html">
            
                <a href="deployments.html#running-with-docker">
            
                    
                    Running with Docker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="deployments.html">
            
                <a href="deployments.html#kubernetes">
            
                    
                    Kubernetes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.2.1" data-path="deployments.html">
            
                <a href="deployments.html#kicking-the-tires">
            
                    
                    Kicking the Tires
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="bundles.html">
            
                <a href="bundles.html">
            
                    
                    Bundles
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="bundles.html">
            
                <a href="bundles.html#bundle-service-api">
            
                    
                    Service API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="bundles.html">
            
                <a href="bundles.html#bundle-file-format">
            
                    
                    File Format
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="bundles.html">
            
                <a href="bundles.html#multiple-sources-of-policy-and-data">
            
                    
                    Multiple Sources
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="status.html">
            
                <a href="status.html">
            
                    
                    Status
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="status.html">
            
                <a href="status.html#status-service-api">
            
                    
                    Service API
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="decision_logs.html">
            
                <a href="decision_logs.html">
            
                    
                    Decision Logs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="decision_logs.html">
            
                <a href="decision_logs.html#decision-log-service-api">
            
                    
                    Service API
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="monitoring.html">
            
                <a href="monitoring.html">
            
                    
                    Monitoring
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="monitoring.html">
            
                <a href="monitoring.html#prometheus">
            
                    
                    Prometheus
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" data-path="discovery.html">
            
                <a href="discovery.html">
            
                    
                    Discovery
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="discovery.html">
            
                <a href="discovery.html#discovery-service-api">
            
                    
                    Service API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="discovery.html">
            
                <a href="discovery.html#example">
            
                    
                    Example
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.3" data-path="discovery.html">
            
                <a href="discovery.html#limitations">
            
                    
                    Limitations
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="security.html">
            
                <a href="security.html">
            
                    
                    Security
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.14.1" data-path="security.html">
            
                <a href="security.html#tls-and-https">
            
                    
                    TLS and HTTPS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.14.2" data-path="security.html">
            
                <a href="security.html#authentication-and-authorization">
            
                    
                    Authentication and Authorization
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.15" data-path="plugins.html">
            
                <a href="plugins.html">
            
                    
                    Plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="faq.html">
            
                <a href="faq.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" data-path="comparison-to-other-systems.html">
            
                <a href="comparison-to-other-systems.html">
            
                    
                    Comparison to Other Systems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.1" data-path="comparison-to-other-systems.html">
            
                <a href="comparison-to-other-systems.html#role-based-access-control-rbac">
            
                    
                    RBAC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.2" data-path="comparison-to-other-systems.html">
            
                <a href="comparison-to-other-systems.html#attribute-based-access-control-abac">
            
                    
                    ABAC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.3" data-path="comparison-to-other-systems.html">
            
                <a href="comparison-to-other-systems.html#amazon-web-services-iam">
            
                    
                    AWS IAM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.4" data-path="comparison-to-other-systems.html">
            
                <a href="comparison-to-other-systems.html#xacml">
            
                    
                    XACML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">Tutorials</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="get-started.html">
            
                <a href="get-started.html">
            
                    
                    Get Started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="docker-authorization.html">
            
                <a href="docker-authorization.html">
            
                    
                    Docker Authorization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="http-api-authorization.html">
            
                <a href="http-api-authorization.html">
            
                    
                    HTTP API Authorization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="ssh-and-sudo-authorization.html">
            
                <a href="ssh-and-sudo-authorization.html">
            
                    
                    SSH and sudo Authorization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="kafka-authorization.html">
            
                <a href="kafka-authorization.html">
            
                    
                    Kafka Authorization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.6" data-path="kubernetes-admission-control.html">
            
                <a href="kubernetes-admission-control.html">
            
                    
                    Kubernetes Admission Control
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.7" data-path="terraform.html">
            
                <a href="terraform.html">
            
                    
                    Terraform Testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="ceph-authorization.html">
            
                <a href="ceph-authorization.html">
            
                    
                    Ceph Authorization
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Best Practices</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="best-practice-identity.html">
            
                <a href="best-practice-identity.html">
            
                    
                    Identity and User attributes
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".">Terraform Testing</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="terraform-testing">Terraform Testing</h1>
<p>Terraform lets you describe the infrastructure you want and automatically creates, deletes, and modifies
your existing infrastructure to match.  OPA makes it possible to write policies that test the changes
Terraform is about to make before it makes them.  Such tests help in different ways:</p>
<ul>
<li>tests help individual developers sanity check their Terraform changes</li>
<li>tests can auto-approve run-of-the-mill infrastructure changes and reduce
the burden of peer-review</li>
<li>tests can help catch problems that arise when applying Terraform to production after applying it to staging</li>
</ul>
<h2 id="goals">Goals</h2>
<p>In this tutorial, you&apos;ll learn how to use OPA to implement unit tests for Terraform plans that create
and delete auto-scaling groups and servers.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>This tutorial requires</p>
<ul>
<li><a href="https://releases.hashicorp.com/terraform/0.8.8/" target="_blank">Terraform 0.8</a></li>
<li><a href="https://github.com/open-policy-agent/opa/releases" target="_blank">OPA</a></li>
<li><a href="https://github.com/palantir/tfjson" target="_blank">tfjson</a> (<code>go get github.com/palantir/tfjson</code>): a Go utility that converts Terraform plans into JSON</li>
</ul>
<p>(This tutorial <em>should</em> also work with the <a href="https://www.terraform.io/downloads.html" target="_blank">latest version of Terraform</a>
and the <a href="https://github.com/philips/tfjson" target="_blank">latest version of tfjson</a>, but it is untested.  Contributions welcome!)</p>
<h2 id="steps">Steps</h2>
<h3 id="1-create-and-save-a-terraform-plan">1. Create and save a Terraform plan</h3>
<p>Create a <a href="https://www.terraform.io/docs/index.html" target="_blank">Terraform</a> file that includes an
auto-scaling group and a server on AWS.  (You will need to modify the <code>shared_credentials_file</code>
to point to your AWS credentials.)</p>
<pre><code class="lang-shell">cat &gt;main.tf &lt;&lt;EOF
provider &quot;aws&quot; {
    region = &quot;us-west-1&quot;
}
resource &quot;aws_instance&quot; &quot;web&quot; {
  instance_type = &quot;t2.micro&quot;
  ami = &quot;ami-09b4b74c&quot;
}
resource &quot;aws_autoscaling_group&quot; &quot;my_asg&quot; {
  availability_zones        = [&quot;us-west-1a&quot;]
  name                      = &quot;my_asg&quot;
  max_size                  = 5
  min_size                  = 1
  health_check_grace_period = 300
  health_check_type         = &quot;ELB&quot;
  desired_capacity          = 4
  force_delete              = true
  launch_configuration      = &quot;my_web_config&quot;
}
resource &quot;aws_launch_configuration&quot; &quot;my_web_config&quot; {
    name = &quot;my_web_config&quot;
    image_id = &quot;ami-09b4b74c&quot;
    instance_type = &quot;t2.micro&quot;
}
EOF
</code></pre>
<p>Then ask Terraform to calculate what changes it will make and store the output in <code>plan.binary</code>.</p>
<pre><code class="lang-shell">terraform plan --out tfplan.binary
</code></pre>
<h3 id="2-convert-the-terraform-plan-into-json">2. Convert the Terraform plan into JSON</h3>
<p>Use the <code>tfjson</code> tool to convert the Terraform plan into JSON so that OPA can read the plan.</p>
<pre><code class="lang-shell">tfjson tfplan.binary &gt; tfplan.json
</code></pre>
<p>Here is the expected contents of <code>tfplan.json</code>.</p>
<pre><code>{
    &quot;aws_autoscaling_group.my_asg&quot;: {
        &quot;arn&quot;: &quot;&quot;,
        &quot;availability_zones.#&quot;: &quot;1&quot;,
        &quot;availability_zones.3205754986&quot;: &quot;us-west-1a&quot;,
        &quot;default_cooldown&quot;: &quot;&quot;,
        &quot;desired_capacity&quot;: &quot;4&quot;,
        &quot;destroy&quot;: false,
        &quot;destroy_tainted&quot;: false,
        &quot;force_delete&quot;: &quot;true&quot;,
        &quot;health_check_grace_period&quot;: &quot;300&quot;,
        &quot;health_check_type&quot;: &quot;ELB&quot;,
        &quot;id&quot;: &quot;&quot;,
        &quot;launch_configuration&quot;: &quot;my_web_config&quot;,
        &quot;load_balancers.#&quot;: &quot;&quot;,
        &quot;max_size&quot;: &quot;5&quot;,
        &quot;metrics_granularity&quot;: &quot;1Minute&quot;,
        &quot;min_size&quot;: &quot;1&quot;,
        &quot;name&quot;: &quot;my_asg&quot;,
        &quot;protect_from_scale_in&quot;: &quot;false&quot;,
        &quot;vpc_zone_identifier.#&quot;: &quot;&quot;,
        &quot;wait_for_capacity_timeout&quot;: &quot;10m&quot;
    },
    &quot;aws_instance.web&quot;: {
        &quot;ami&quot;: &quot;ami-09b4b74c&quot;,
        &quot;associate_public_ip_address&quot;: &quot;&quot;,
        &quot;availability_zone&quot;: &quot;&quot;,
        &quot;destroy&quot;: false,
        &quot;destroy_tainted&quot;: false,
        &quot;ebs_block_device.#&quot;: &quot;&quot;,
        &quot;ephemeral_block_device.#&quot;: &quot;&quot;,
        &quot;id&quot;: &quot;&quot;,
        &quot;instance_state&quot;: &quot;&quot;,
        &quot;instance_type&quot;: &quot;t2.micro&quot;,
        &quot;ipv6_addresses.#&quot;: &quot;&quot;,
        &quot;key_name&quot;: &quot;&quot;,
        &quot;network_interface_id&quot;: &quot;&quot;,
        &quot;placement_group&quot;: &quot;&quot;,
        &quot;private_dns&quot;: &quot;&quot;,
        &quot;private_ip&quot;: &quot;&quot;,
        &quot;public_dns&quot;: &quot;&quot;,
        &quot;public_ip&quot;: &quot;&quot;,
        &quot;root_block_device.#&quot;: &quot;&quot;,
        &quot;security_groups.#&quot;: &quot;&quot;,
        &quot;source_dest_check&quot;: &quot;true&quot;,
        &quot;subnet_id&quot;: &quot;&quot;,
        &quot;tenancy&quot;: &quot;&quot;,
        &quot;vpc_security_group_ids.#&quot;: &quot;&quot;
    },
    &quot;aws_launch_configuration.my_web_config&quot;: {
        &quot;associate_public_ip_address&quot;: &quot;false&quot;,
        &quot;destroy&quot;: false,
        &quot;destroy_tainted&quot;: false,
        &quot;ebs_block_device.#&quot;: &quot;&quot;,
        &quot;ebs_optimized&quot;: &quot;&quot;,
        &quot;enable_monitoring&quot;: &quot;true&quot;,
        &quot;id&quot;: &quot;&quot;,
        &quot;image_id&quot;: &quot;ami-09b4b74c&quot;,
        &quot;instance_type&quot;: &quot;t2.micro&quot;,
        &quot;key_name&quot;: &quot;&quot;,
        &quot;name&quot;: &quot;my_web_config&quot;,
        &quot;root_block_device.#&quot;: &quot;&quot;
    },
    &quot;destroy&quot;: false
}
</code></pre><h3 id="3-write-the-opa-policy-to-check-the-plan">3. Write the OPA policy to check the plan</h3>
<p>The policy computes a score for a Terraform that combines</p>
<ul>
<li>The number of deletions of each resource type</li>
<li>The number of creations of each resource type</li>
<li>The number of modifications of each resource type</li>
</ul>
<p>The policy authorizes the plan when the score for the plan is below a threshold
and there are no changes made to any IAM resources.
(For simplicity, the threshold in this tutorial is the same for everyone, but in
practice you would vary the threshold depending on the user.)</p>
<p><strong>terraform.rego</strong>:</p>
<pre><code class="lang-ruby">package terraform.analysis

import input as tfplan

<span class="hljs-comment">########################</span>
<span class="hljs-comment"># Parameters for Policy</span>
<span class="hljs-comment">########################</span>

<span class="hljs-comment"># acceptable score for automated authorization</span>
blast_radius = <span class="hljs-number">30</span>

<span class="hljs-comment"># weights assigned for each operation on each resource-type</span>
weights = {
    <span class="hljs-string">&quot;aws_autoscaling_group&quot;</span><span class="hljs-symbol">:</span> {<span class="hljs-string">&quot;delete&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">100</span>, <span class="hljs-string">&quot;create&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">10</span>, <span class="hljs-string">&quot;modify&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">1</span>},
    <span class="hljs-string">&quot;aws_instance&quot;</span><span class="hljs-symbol">:</span> {<span class="hljs-string">&quot;delete&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">10</span>, <span class="hljs-string">&quot;create&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">1</span>, <span class="hljs-string">&quot;modify&quot;</span><span class="hljs-symbol">:</span> <span class="hljs-number">1</span>}
}

<span class="hljs-comment"># Consider exactly these resource types in calculations</span>
resource_types = {<span class="hljs-string">&quot;aws_autoscaling_group&quot;</span>, <span class="hljs-string">&quot;aws_instance&quot;</span>, <span class="hljs-string">&quot;aws_iam&quot;</span>, <span class="hljs-string">&quot;aws_launch_configuration&quot;</span>}

<span class="hljs-comment">#########</span>
<span class="hljs-comment"># Policy</span>
<span class="hljs-comment">#########</span>

<span class="hljs-comment"># Authorization holds if score for the plan is acceptable and no changes are made to IAM</span>
default authz = <span class="hljs-keyword">false</span>
authz {
    score &lt; blast_radius
    <span class="hljs-keyword">not</span> touches_iam
}

<span class="hljs-comment"># Compute the score for a Terraform plan as the weighted sum of deletions, creations, modifications</span>
score = s {
    all <span class="hljs-symbol">:</span>= [ x |
            crud <span class="hljs-symbol">:</span>= weights[resource_type];
            del <span class="hljs-symbol">:</span>= crud[<span class="hljs-string">&quot;delete&quot;</span>] * num_deletes[resource_type];
            new <span class="hljs-symbol">:</span>= crud[<span class="hljs-string">&quot;create&quot;</span>] * num_creates[resource_type];
            mod <span class="hljs-symbol">:</span>= crud[<span class="hljs-string">&quot;modify&quot;</span>] * num_modifies[resource_type];
            x <span class="hljs-symbol">:</span>= del + new + mod
    ]
    s <span class="hljs-symbol">:</span>= sum(all)
}

<span class="hljs-comment"># Whether there is any change to IAM</span>
touches_iam {
    all <span class="hljs-symbol">:</span>= instance_names[<span class="hljs-string">&quot;aws_iam&quot;</span>]
    count(all) &gt; <span class="hljs-number">0</span>
}

<span class="hljs-comment">####################</span>
<span class="hljs-comment"># Terraform Library</span>
<span class="hljs-comment">####################</span>

<span class="hljs-comment"># list of all resources of a given type</span>
instance_names[resource_type] = all {
    resource_types[resource_type]
    all <span class="hljs-symbol">:</span>= [name |
        tfplan[name] = <span class="hljs-number">_</span>
        startswith(name, resource_type)
    ]
}

<span class="hljs-comment"># number of deletions of resources of a given type</span>
num_deletes[resource_type] = num {
    resource_types[resource_type]
    all <span class="hljs-symbol">:</span>= instance_names[resource_type]
    deletions = [name | name <span class="hljs-symbol">:</span>= all[<span class="hljs-number">_</span>]; tfplan[name][<span class="hljs-string">&quot;destroy&quot;</span>] = <span class="hljs-keyword">true</span>]
    num <span class="hljs-symbol">:</span>= count(deletions)
}

<span class="hljs-comment"># number of creations of resources of a given type</span>
num_creates[resource_type] = num {
    resource_types[resource_type]
    all <span class="hljs-symbol">:</span>= instance_names[resource_type]
    creates = [name | all[<span class="hljs-number">_</span>] = name; tfplan[name][<span class="hljs-string">&quot;id&quot;</span>] = <span class="hljs-string">&quot;&quot;</span>]
    num <span class="hljs-symbol">:</span>= count(creates)
}

<span class="hljs-comment"># number of modifications to resources of a given type</span>
num_modifies[resource_type] = num {
    resource_types[resource_type]
    all <span class="hljs-symbol">:</span>= instance_names[resource_type]
    modifies <span class="hljs-symbol">:</span>= [name | name <span class="hljs-symbol">:</span>= all[<span class="hljs-number">_</span>]; obj <span class="hljs-symbol">:</span>= tfplan[name]; obj[<span class="hljs-string">&quot;destroy&quot;</span>] = <span class="hljs-keyword">false</span>; <span class="hljs-keyword">not</span> obj[<span class="hljs-string">&quot;id&quot;</span>]]
    num <span class="hljs-symbol">:</span>= count(modifies)
}
</code></pre>
<h3 id="4-evaluate-the-opa-policy-on-the-terraform-plan">4. Evaluate the OPA policy on the Terraform plan</h3>
<p>To evaluate the policy against that plan, you hand OPA the policy, the Terraform plan as input, and
ask it to evaluate <code>data.terraform.analysis.authz</code>.</p>
<pre><code class="lang-shell">opa eval --data terraform.rego --input tfplan.json &quot;data.terraform.analysis.authz&quot;
</code></pre>
<p>If you&apos;re curious, you can ask for the score that the policy used to make the authorization decision.
In our example, it is 11 (10 for the creation of the auto-scaling group and 1 for the creation of the server).</p>
<pre><code class="lang-shell">opa eval --data terraform.rego --input tfplan.json &quot;data.terraform.analysis.score&quot;
</code></pre>
<p>If as suggested in the previous step, you want to modify your policy to make an authorization decision
based on both the user and the Terraform plan, the input you would give to OPA would take the form
<code>{&quot;user&quot;: &lt;user&gt;, &quot;plan&quot;: &lt;plan&gt;}</code>, and your policy would reference the user with <code>input.user</code> and
the plan with <code>input.plan</code>.  You could even go so far as to provide the Terraform state file and the AWS
EC2 data to OPA and write policy using all of that context.</p>
<h3 id="5-create-a-large-terraform-plan-and-evaluate-it">5. Create a Large Terraform plan and Evaluate it</h3>
<p>Create a Terraform plan that creates enough resources to exceed the blast-radius permitted
by policy.</p>
<pre><code class="lang-shell">cat &gt;main.tf &lt;&lt;EOF
provider &quot;aws&quot; {
    region = &quot;us-west-1&quot;
}
resource &quot;aws_instance&quot; &quot;web&quot; {
  instance_type = &quot;t2.micro&quot;
  ami = &quot;ami-09b4b74c&quot;
}
resource &quot;aws_autoscaling_group&quot; &quot;my_asg&quot; {
  availability_zones        = [&quot;us-west-1a&quot;]
  name                      = &quot;my_asg&quot;
  max_size                  = 5
  min_size                  = 1
  health_check_grace_period = 300
  health_check_type         = &quot;ELB&quot;
  desired_capacity          = 4
  force_delete              = true
  launch_configuration      = &quot;my_web_config&quot;
}
resource &quot;aws_launch_configuration&quot; &quot;my_web_config&quot; {
    name = &quot;my_web_config&quot;
    image_id = &quot;ami-09b4b74c&quot;
    instance_type = &quot;t2.micro&quot;
}
resource &quot;aws_autoscaling_group&quot; &quot;my_asg2&quot; {
  availability_zones        = [&quot;us-west-2a&quot;]
  name                      = &quot;my_asg2&quot;
  max_size                  = 6
  min_size                  = 1
  health_check_grace_period = 300
  health_check_type         = &quot;ELB&quot;
  desired_capacity          = 4
  force_delete              = true
  launch_configuration      = &quot;my_web_config&quot;
}
resource &quot;aws_autoscaling_group&quot; &quot;my_asg3&quot; {
  availability_zones        = [&quot;us-west-2b&quot;]
  name                      = &quot;my_asg3&quot;
  max_size                  = 7
  min_size                  = 1
  health_check_grace_period = 300
  health_check_type         = &quot;ELB&quot;
  desired_capacity          = 4
  force_delete              = true
  launch_configuration      = &quot;my_web_config&quot;
}
EOF
</code></pre>
<p>Generate the Terraform plan and convert it to JSON.</p>
<pre><code class="lang-shell">terraform plan --out tfplan_large.binary
tfjson tfplan_large.binary &gt; tfplan_large.json
</code></pre>
<p>Evaluate the policy to see that it fails the policy tests and check the score.</p>
<pre><code class="lang-shell">opa eval --data terraform.rego --input tfplan_large.json &quot;data.terraform.analysis.authz&quot;
opa eval --data terraform.rego --input tfplan_large.json &quot;data.terraform.analysis.score&quot;
</code></pre>
<h3 id="6-optional-run-opa-as-a-daemon-and-evaluate-policy">6. (Optional) Run OPA as a daemon and evaluate policy</h3>
<p>In addition to running OPA from the command-line, you can run it as a daemon loaded with the Terraform policy and
then interact with it using its HTTP API.  First, start the daemon:</p>
<pre><code class="lang-shell">opa run -s terraform.rego
</code></pre>
<p>Then in a separate terminal, use OPA&apos;s HTTP API to evaluate the policy against the two Terraform plans.</p>
<pre><code class="lang-shell">curl localhost:8181/v0/data/terraform/analysis/authz -d @tfplan.json
curl localhost:8181/v0/data/terraform/analysis/authz -d @tfplan_large.json
</code></pre>
<h2 id="wrap-up">Wrap Up</h2>
<p>Congratulations for finishing the tutorial!</p>
<p>You learned a number of things about Terraform Testing with OPA:</p>
<ul>
<li>OPA gives you fine-grained policy control over Terraform plans.</li>
<li>You can use data other than the plan itself (e.g. the user) when writing authorization policies.</li>
</ul>
<p>Keep in mind that it&apos;s up to you to decide how to use OPA&apos;s Terraform tests and authorization decision.  Here are some ideas.</p>
<ul>
<li>Add it as part of your Terraform wrapper to implement unit tests on Terraform plans</li>
<li>Use it to automatically approve run-of-the-mill Terraform changes to reduce the burden of peer-review</li>
<li>Embed it into your deployment system to catch problems that arise when applying Terraform to production after applying it to staging</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class="search-results-count"></span> results matching &quot;<span class="search-query"></span>&quot;</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching &quot;<span class="search-query"></span>&quot;</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="kubernetes-admission-control.html" class="navigation navigation-prev " aria-label="Previous page: Kubernetes Admission Control">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="ceph-authorization.html" class="navigation navigation-next " aria-label="Next page: Ceph Authorization">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Terraform Testing","level":"2.7","depth":1,"next":{"title":"Ceph Authorization","level":"2.8","depth":1,"path":"ceph-authorization.md","ref":"ceph-authorization.md","articles":[]},"previous":{"title":"Kubernetes Admission Control","level":"2.6","depth":1,"path":"kubernetes-admission-control.md","ref":"kubernetes-admission-control.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["header","addcssjs","collapsible-menu","custom-favicon","ga","-fontsettings","ace"],"pluginsConfig":{"collapsible-menu":{},"ace":{},"search":{},"layout":{"headerPath":"layouts/header.html"},"addcssjs":{"css":[],"js":[]},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"header":{},"highlight":{},"favicon":"images/favicon.png","custom-favicon":{},"ga":{"configuration":"auto","token":"UA-84550302-1"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"terraform.md","mtime":"2019-02-19T21:05:45.225Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-02-19T21:06:41.554Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    

    

    </body>
</html>

